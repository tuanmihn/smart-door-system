<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Khóa Cửa 2 Lớp: Vân Tay + Khuôn Mặt</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f4f6f9;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: auto;
      }
      .card {
        background: white;
        padding: 20px;
        margin: 15px 0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #2c3e50;
      }
      .status {
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .ok {
        background: #d4edda;
        color: #155724;
      }
      .wait {
        background: #fff3cd;
        color: #856404;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .log {
        background: #e9ecef;
        padding: 12px;
        border-radius: 8px;
        font-family: monospace;
        white-space: pre-line;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      #preview {
        max-width: 200px;
        margin: 10px 0;
        border-radius: 8px;
        display: none;
      }
      .btn-primary {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 20px;
        margin: 8px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
      }
      .btn-primary:hover {
        background: #2980b9;
      }
      .btn-primary:active {
        background: #1c6ea4;
      }
      .manual-msg {
        margin-top: 10px;
        color: #e74c3c;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Khóa Cửa 2 Lớp: Vân Tay + Khuôn Mặt</h1>

      <!-- TRẠNG THÁI HỆ THỐNG -->
      <div class="card">
        <h2>Trạng Thái Hệ Thống</h2>
        <div id="fingerprint" class="status wait">
          <span>Vân tay: Chưa quét</span>
          <button id="btnFingerprint" class="btn-primary">
            Nhận Diện Vân Tay
          </button>
        </div>
        <div id="face" class="status wait">
          <span>Khuôn mặt: Chưa nhận diện</span>
          <button id="btnFace" class="btn-primary">Nhận Diện Khuôn Mặt</button>
        </div>
        <div id="door" class="status error">Cửa: Đóng</div>
        <div id="log" class="log"></div>
        <div id="manualMsg" class="manual-msg"></div>
      </div>

      <!-- ĐĂNG KÝ NGƯỜI DÙNG -->
      <div class="card">
        <h2>Đăng Ký Người Dùng Mới</h2>
        <!-- ĐẢM BẢO CÓ ĐỦ 3 TRƯỜNG -->
        <form id="registerForm" enctype="multipart/form-data">
          <input type="text" placeholder="Tên (VD: Nam)" name="name" required />
          <input
            type="number"
            placeholder="ID vân tay (1-127)"
            name="fingerprint_id"
            min="1"
            max="127"
            required
          />
          <input
            type="file"
            accept="image/*"
            name="image"
            id="imgInput"
            required
          />
          <button type="submit">Đăng Ký</button>
        </form>
        <img id="preview" alt="Preview" />
        <p id="regMsg" style="margin-top: 10px"></p>
      </div>

      <!-- DANH SÁCH NGƯỜI DÙNG -->
      <div class="card">
        <h2>Người Dùng Đã Đăng Ký</h2>
        <div id="userList">Đang tải...</div>
      </div>
    </div>

    <script>
      // CẬP NHẬT TRẠNG THÁI MỖI 500ms
      function updateStatus() {
        fetch("/status")
          .then((r) => r.json())
          .then((data) => {
            document.getElementById(
              "fingerprint"
            ).firstElementChild.textContent = "Vân tay: " + data.fingerprint;
            document.getElementById("face").firstElementChild.textContent =
              "Khuôn mặt: " + data.face;
            document.getElementById("door").textContent = "Cửa: " + data.door;
            document.getElementById("log").textContent = data.last_log;

            // Danh sách người dùng
            const users = Array.isArray(data.users) ? data.users : [];
            document.getElementById("userList").innerHTML =
              users.length > 0
                ? users.map((u) => `• ${u}`).join("<br>")
                : "Chưa có ai";

            // Đổi màu
            setClass(
              "fingerprint",
              data.fingerprint.includes("Đúng"),
              "ok",
              "wait"
            );
            setClass("face", data.face.includes("Đúng"), "ok", "wait");
            setClass("door", data.door === "Mở", "ok", "error");
          })
          .catch((err) => console.error("Lỗi fetch:", err));
      }

      function setClass(id, cond, okCls, waitCls) {
        const el = document.getElementById(id);
        el.className = cond ? `status ${okCls}` : `status ${waitCls}`;
      }

      // === SỬA HÀM ĐĂNG KÝ ===
      document.getElementById("registerForm").onsubmit = function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("/register", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((err) => {
                throw err;
              });
            }
            return response.json();
          })
          .then((res) => {
            document.getElementById("regMsg").textContent = res.message;
            document.getElementById("regMsg").style.color = res.success
              ? "green"
              : "red";
            if (res.success) {
              this.reset();
              document.getElementById("preview").style.display = "none";
              updateStatus();
            }
          })
          .catch((err) => {
            console.error("Lỗi:", err);
            document.getElementById("regMsg").textContent =
              err.message || "Lỗi không xác định";
            document.getElementById("regMsg").style.color = "red";
          });
      };

      // PREVIEW ẢNH
      document.getElementById("imgInput").onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          const prev = document.getElementById("preview");
          prev.src = url;
          prev.style.display = "block";
        }
      };

      // NÚT NHẬN DIỆN VÂN TAY
      document.getElementById("btnFingerprint").onclick = function () {
        this.disabled = true;
        document.getElementById("manualMsg").textContent = "Đang gửi lệnh...";
        fetch("/trigger_fingerprint", { method: "POST" })
          .then((r) => r.json())
          .then((res) => {
            document.getElementById("manualMsg").textContent = res.message;
            setTimeout(() => {
              this.disabled = false;
            }, 3000);
          })
          .catch(() => {
            document.getElementById("manualMsg").textContent = "Lỗi kết nối!";
            this.disabled = false;
          });
      };

      // NÚT NHẬN DIỆN KHUÔN MẶT
      // === SỬA NÚT NHẬN DIỆN KHUÔN MẶT ===
      document.getElementById("btnFace").onclick = function () {
        this.disabled = true;
        document.getElementById("manualMsg").textContent = "Đang mở camera...";
        document.getElementById("manualMsg").style.color = "orange";

        fetch("/trigger_face", { method: "POST" })
          .then((r) => r.json())
          .then((res) => {
            document.getElementById("manualMsg").textContent = res.message;
            document.getElementById("manualMsg").style.color = "green";
            this.disabled = false;
          })
          .catch(() => {
            document.getElementById("manualMsg").textContent = "Lỗi kết nối!";
            document.getElementById("manualMsg").style.color = "red";
            this.disabled = false;
          });
      };

      // KHỞI ĐỘNG

      // updateStatus();
      // === SỬA KHỞI ĐỘNG JS ===
      window.onload = function () {
        updateStatus(); // GỌI NGAY KHI TẢI TRANG
        setInterval(updateStatus, 500);
      };
    </script>
  </body>
</html>
